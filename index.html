<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Epidermys ‚Äì Upload Foto</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Scatta Foto e Avvia Analisi</h1>

  <button onclick="handleAuth()">üîê Autorizza con Google</button><br><br>
  <input type="file" accept="image/*" id="photoInput" capture="environment" style="display:none" />
  <button onclick="document.getElementById('photoInput').click()">üì∏ Scatta Foto</button><br><br>
  <img id="preview" src="#" style="max-width:300px; display:none"/>

  <script>
    const CLIENT_ID = '208608835457-ac67sskc...apps.googleusercontent.com'; // inserisci completo
    const API_KEY = 'INSERISCI_API_KEY'; // inserisci qui la tua chiave API
    const FOLDER_ID = '17UQfGDhvgIY35Q63oG4aPuXEEyVl3uqi';

    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let tokenClient;
    let accessToken = null;

    function handleAuth() {
      gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY });
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            alert('‚úÖ Autorizzazione completata.');
          }
        });
        tokenClient.requestAccessToken();
      });
    }

    document.getElementById('photoInput').addEventListener('change', async () => {
      const file = document.getElementById('photoInput').files[0];
      if (!file || !accessToken) return;

      const reader = new FileReader();
      reader.onloadend = async () => {
        document.getElementById('preview').src = reader.result;
        document.getElementById('preview').style.display = 'block';

        const metadata = {
          name: 'foto_' + Date.now() + '.jpg',
          parents: [FOLDER_ID]
        };

        const boundary = '-------314159265358979323846';
        const delimiter = '\\r\\n--' + boundary + '\\r\\n';
        const close_delim = '\\r\\n--' + boundary + '--';
        const contentType = file.type;
        const base64Data = reader.result.split(',')[1];

        const multipartRequestBody =
          delimiter +
          'Content-Type: application/json; charset=UTF-8\\r\\n\\r\\n' +
          JSON.stringify(metadata) +
          delimiter +
          'Content-Type: ' + contentType + '\\r\\n' +
          'Content-Transfer-Encoding: base64\\r\\n\\r\\n' +
          base64Data +
          close_delim;

        const response = await fetch(
          'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
          {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + accessToken,
              'Content-Type': 'multipart/related; boundary=' + boundary,
            },
            body: multipartRequestBody
          }
        );

        const result = await response.json();
        localStorage.setItem('lastFileId', result.id);
        alert('‚úÖ Foto caricata su Drive. File ID: ' + result.id);
        window.location.href = 'risultati.html';
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
