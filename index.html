from flask import Flask, request, jsonify
from flask_cors import CORS
import cv2, os, uuid, traceback, ftplib
import numpy as np
from PIL import Image
from skimage.color import rgb2lab

from maschera_viso import genera_maschera_frontale
from fototipo_utils import stima_fototipo
from red_areas import calcola_red_areas
from evenness import calcola_evenness
from texture_analysis import calcola_texture  # modulo per texture

# === BunnyCDN config ===
FTP_HOST = "storage.bunnycdn.com"
FTP_USER = "epidermys"
FTP_PASS = "43a153c5-f05c-455c-9651c67f05a6-5a19-489f"
BUNNY_BASE_URL = "https://epidermys-cdn.b-cdn.net"
BUNNY_FOLDER = "overlays"

app = Flask(__name__)
CORS(app, origins="*")

# === Upload su BunnyCDN ===
def upload_to_bunny(local_path, filename):
    try:
        with ftplib.FTP(FTP_HOST, FTP_USER, FTP_PASS) as ftp:
            ftp.cwd(BUNNY_FOLDER)
            with open(local_path, "rb") as f:
                ftp.storbinary(f"STOR " + filename, f)
        return f"{BUNNY_BASE_URL}/{BUNNY_FOLDER}/{filename}"
    except Exception as e:
        print("‚ùå Errore upload BunnyCDN:", e)
        return None

# === Salva e carica su BunnyCDN ===
def salva_overlay_su_bunny(img, prefix):
    filename = f"{prefix}_{uuid.uuid4().hex}.png"
    local_path = os.path.join("/tmp", filename)
    cv2.imwrite(local_path, cv2.cvtColor(img, cv2.COLOR_RGB2BGR))
    return upload_to_bunny(local_path, filename)

@app.route("/analyze", methods=["POST"])
def analyze():
    try:
        file = request.files.get("image")
        image = Image.open(file.stream).convert("RGB")
        image_rgb = np.array(image).astype(np.uint8)

        # === Equalizzazione LAB ===
        lab = cv2.cvtColor(image_rgb, cv2.COLOR_RGB2LAB)
        l, a, b = cv2.split(lab)
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
        l_clahe = clahe.apply(l)
        lab_eq = cv2.merge((l_clahe, a, b))
        image_rgb = cv2.cvtColor(lab_eq, cv2.COLOR_LAB2RGB)

        # === Maschera viso ===
        mask_rgba = genera_maschera_frontale(image_rgb)
        face_mask = mask_rgba[:, :, 3]

        # === Fototipo LAB ===
        lab = rgb2lab(image_rgb)
        L, A, B = lab[:, :, 0], lab[:, :, 1], lab[:, :, 2]
        fototipo, L_medio, n_validi = stima_fototipo(L, A, B, face_mask)
        print(f"üìä Fototipo stimato: {fototipo} (L medio: {L_medio:.2f}, validi: {n_validi})")

        # === Analisi Red Areas ===
        overlay_red, percent_red, pixel_face_red, pixel_red = calcola_red_areas(image_rgb, face_mask, L, A, B)

        # === Analisi Evenness ===
        results_even = calcola_evenness(image_rgb)
        overlay_even = results_even["overlay"]
        percent_even = results_even["percentuale_disomogeneita"]
        score_even = results_even["eveness_score"]

        # === Analisi Texture ===
        results_texture = calcola_texture(image_rgb)
        overlay_texture = results_texture["overlay"]
        zone_texture = results_texture["risultati_zone"]

        # === Upload overlay su BunnyCDN ===
        url_red = salva_overlay_su_bunny(overlay_red, "red_areas")
        url_even = salva_overlay_su_bunny(overlay_even, "evenness")
        url_texture = salva_overlay_su_bunny(overlay_texture, "texture")

        return jsonify({
            "status": "ok",
            "fototipo_stimato": fototipo,
            "percentuale_red_areas": round(percent_red, 2),
            "pixel_totali": int(pixel_face_red),
            "pixel_red": int(pixel_red),
            "percentuale_evenness": round(percent_even, 2),
            "evenness_score": round(score_even, 2),
            "overlay_red_url": url_red,
            "overlay_evenness_url": url_even,
            "overlay_texture_url": url_texture,
            "texture_zones": zone_texture
        })

    except Exception as e:
        traceback.print_exc()
        return jsonify({"status": "error", "message": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=7860)
