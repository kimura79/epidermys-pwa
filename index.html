<script>
  const modal = document.getElementById("modal");
  const photoInput = document.getElementById("photoInput");
  const uploadBox = document.getElementById("uploadBox");
  const preview = document.getElementById("preview");
  const uploadText = document.getElementById("uploadText");

  uploadBox.addEventListener("click", () => {
    modal.style.display = "flex";
  });

  function proseguiScatto() {
    const nome = document.getElementById("nome").value;
    const cognome = document.getElementById("cognome").value;
    const data = document.getElementById("dataNascita").value;

    if (nome && cognome && data) {
      modal.style.display = "none";
      photoInput.click();
    } else {
      alert("Compila tutti i campi.");
    }
  }

  async function analizzaFotoConRunPod(base64Image, dataNascita) {
    const endpoint = "https://TUO-POD-ID-5000.proxy.runpod.net/analyze"; // <--- sostituisci con il vero URL

    const base64Clean = base64Image.split(",")[1];

    const response = await fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        image_base64: base64Clean,
        data_nascita: dataNascita
      })
    });

    const result = await response.json();
    console.log("Risultato:", result);

    if (result && result.fototipo) {
      localStorage.setItem("gpt_output", JSON.stringify(result));
      window.location.href = "risultati.html";
    } else {
      alert("Errore: risposta non valida dal server.");
    }
  }

  photoInput.addEventListener("change", () => {
    const file = photoInput.files[0];
    const data = document.getElementById("dataNascita").value;

    if (file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result;
        preview.src = base64;
        preview.style.display = "block";
        uploadText.style.display = "none";

        localStorage.setItem("imageData", base64);
        await analizzaFotoConRunPod(base64, data);
      };
      reader.readAsDataURL(file);
    }
  });
</script>
