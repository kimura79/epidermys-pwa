<!-- index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Epidermys PWA â€“ Analisi Viso</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Helvetica, sans-serif; padding: 2em; background-color: #fff; display: flex; flex-direction: column; align-items: center; }
    .upload-box { width: 300px; height: 400px; border: 2px solid #2261a9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
    .upload-box span { font-size: 48px; color: #2261a9; }
    #preview { width: 100%; height: 100%; object-fit: cover; display: none; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; }
    .modal-content input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    .modal-content button { background-color: #2261a9; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>

  <div class="upload-box" id="uploadBox">
    <span id="uploadText">+</span>
    <img id="preview" src="#" alt="Anteprima">
  </div>

  <input type="file" accept="image/*" id="photoInput" capture="environment" style="display: none;">

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2>Inserisci Dati Paziente</h2>
      <input type="text" id="nome" placeholder="Nome">
      <input type="text" id="cognome" placeholder="Cognome">
      <input type="date" id="dataNascita">
      <button id="continuaBtn">Continua</button>
    </div>
  </div>

  <script>
    const CLIENT_ID = '208608835457-ac67ssckuq0jmn9laavdpol4lsuthnkm.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDVID4DMYceBmam9oYzNRzAbtq0hr_79Nk';
    const FOLDER_ID = '17UQfGDhvgIY35Q63oG4aPuXEEyVl3uqi';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    const modal = document.getElementById("modal");
    const uploadBox = document.getElementById("uploadBox");
    const photoInput = document.getElementById("photoInput");
    const preview = document.getElementById("preview");
    const uploadText = document.getElementById("uploadText");

    let accessToken = null;

    uploadBox.addEventListener("click", () => {
      modal.style.display = "flex";
    });

    document.getElementById("continuaBtn").addEventListener("click", async () => {
      const nome = document.getElementById("nome").value;
      const cognome = document.getElementById("cognome").value;
      const data = document.getElementById("dataNascita").value;

      if (!(nome && cognome && data)) return alert("Compila tutti i campi.");
      modal.style.display = "none";

      // Autorizzazione Google
      await new Promise(resolve => {
        google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: token => {
            accessToken = token.access_token;
            resolve();
          }
        }).requestAccessToken();
      });

      // Chiede selezione immagine
      photoInput.click();
    });

    photoInput.addEventListener("change", async () => {
      const file = photoInput.files[0];
      if (!file || !accessToken) return;

      const reader = new FileReader();
      reader.onloadend = async () => {
        preview.src = reader.result;
        preview.style.display = "block";
        uploadText.style.display = "none";

        const boundary = '-------314159265358979323846';
        const metadata = {
          name: 'foto_' + Date.now() + '.jpg',
          parents: [FOLDER_ID]
        };

        const base64Data = reader.result.split(',')[1];
        const multipartRequestBody =
          `--${boundary}\r\nContent-Type: application/json\r\n\r\n` +
          JSON.stringify(metadata) +
          `\r\n--${boundary}\r\nContent-Type: ${file.type}\r\nContent-Transfer-Encoding: base64\r\n\r\n` +
          base64Data +
          `\r\n--${boundary}--`;

        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'multipart/related; boundary=' + boundary,
          },
          body: multipartRequestBody
        }).then(res => res.json())
          .then(result => {
            localStorage.setItem("lastFileId", result.id);
            window.location.href = "risultati.html";
          }).catch(err => alert("Errore upload: " + err));
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
